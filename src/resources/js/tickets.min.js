var ticketHeaderImage=window.ticketHeaderImage||{};!function(t,i,a){"use strict";var r=i(document.getElementById("tribe-event-datepickers")),n=i(document.getElementById("tribetickets")),c=i(document.getElementById("event_tickets")),d=i(document.getElementById("tribe-tickets-enable-global-stock")),o=i(document.getElementById("tribe-tickets-global-stock-level")),s=!1,l=i("html, body"),_=0,g=i(document.getElementById("panel_base")),k=i(document.getElementById("panel_edit")),m=i(document.getElementById("panel_settings"));ticketHeaderImage={uploader:function(){var t=wp.media({title:HeaderImageData.title,multiple:!1,library:{type:"image"},button:{text:HeaderImageData.button}});return t.on("close",function(){var e=t.state().get("selection").toJSON();e.length&&ticketHeaderImage.render(e[0])}),t.open(),!1},render:function(t){i("#tribe_ticket_header_preview").html(ticketHeaderImage.imgHTML(t)),i("#tribe_ticket_header_image_id").val(t.id),i("#tribe_ticket_header_remove").show()},imgHTML:function(t){var e='<img src="'+t.url+'" ';return e+='width="'+t.width+'" ',e+='height="'+t.height+'" ',e+="/>"}},i(document).ready(function(){function a(){return d.prop("checked")}function p(){s=!0,n.trigger("set-global-stock-fields.tribe")}function u(){i("tr.ticket_advanced").hide(),i("tr.ticket_advanced_"+f()+":not(.sale_price)").show(),n.trigger("set-advanced-fields.tribe"),i(document.getElementById("tribetickets")).trigger("ticket-provider-changed.tribe")}function f(){var t=i('input[name="ticket_provider"]:checked');return t.length>0?t[0].value:""}function h(){var t=n.find("tr.ticket_advanced.history");if(t.length){var e=t.find("a.toggle-history"),i=e.find("span"),a=t.find("ul");t.find("a.toggle-history").click(function(t){return i.toggle(),a.toggle(),t.stopPropagation(),!1})}}function v(t){var e={};"absolute"!==g.css("position")?(e[t]="-100%",g.animate(e).css({position:"absolute"})):(e[t]="0",g.css({position:"relative"}).animate(e))}function b(){"absolute"!==k.css("position")?k.animate({left:"100%"}).css({position:"absolute"}):k.css({position:"relative"}).animate({left:"0"})}function y(){"absolute"!==m.css("position")?m.animate({top:"100%"}).css({position:"absolute"}):m.css({position:"relative"}).animate({top:"0"})}n.on({"spin.tribe":function(t,e){("undefined"==typeof e||i.inArray(e,["start","stop"]))&&(e="stop"),"stop"===e?c.css("opacity","1").find("#tribe-loading").hide():c.css("opacity","0.5").find("#tribe-loading").show()},"clear.tribe":function(){var t=i(this),e=t.find("#ticket_form"),a=e.find("tr:not(.event-wide-settings)");t.find("a#ticket_form_toggle").show(),a.find('input:not(:button):not(:radio):not(:checkbox):not([type="hidden"]), textarea').val(""),a.find("input:checkbox").attr("checked",!1),a.find("#ticket_id").val(""),t.find('#ticket_form input[name="show_attendee_info"]').prop("checked",!1).change(),t.find("input[data-default-value]").each(function(){var t=i(this);t.val(t.data("default-value"))}),t.find("#ticket_start_date").datepicker("option","maxDate",null),t.find("#ticket_end_date").datepicker("option","minDate",null),t.find(".ticket_start_time, .ticket_end_time, .ticket.sale_price").hide(),t.find("#ticket_price").removeProp("disabled").siblings(".no-update-message").html("").hide().end().siblings(".description").show(),i("#tribe-tickets-attendee-sortables").empty(),i(".tribe-tickets-attendee-saved-fields").show(),e.hide()},"focus.tribe":function(){l.animate({scrollTop:c.offset().top-50},500)},"edit-tickets-complete.tribe":function(){h()},"set-advanced-fields.tribe":function(){var t=i(this),e=t.find("#ticket_form"),a=e.find("tr.ticket_advanced:not(.ticket_advanced_meta)").find("input, select, textarea"),r=e.find(".ticket_provider:checked").val();a.each(function(){var t=i(this);t.attr("name")&&t.data("name",t.attr("name")).attr({name:"",id:""}),t.closest("tr").hasClass("ticket_advanced_"+r)&&t.data("name")&&0===t.attr("name").length&&t.attr({name:t.data("name"),id:t.data("name")})}),n.trigger("set-global-stock-fields.tribe"),i("#ticket_global_stock").change(function(){n.trigger("set-global-stock-fields.tribe")})},"set-global-stock-fields.tribe":function(){var t=f(),e=i(this).find("#ticket_form").find(".ticket_advanced_"+t);if(!(e.length<1)){var r=e.filter(".stock"),n=e.filter(".global-stock-mode"),c=n.filter(".sales-cap-field"),d=i("#ticket_global_stock").val(),s=a();if(o.toggle(s),n.toggle(a()),r.toggle(!s),s)switch(d){case"global":c.hide(),r.hide();break;case"capped":c.show(),r.hide();break;case"own":c.hide(),r.show()}}}}),r.length&&(_=r.data("startofweek"));var w={dateFormat:"yy-mm-dd",showAnim:"fadeIn",changeMonth:!0,changeYear:!0,numberOfMonths:3,firstDay:_,showButtonPanel:!1,onChange:function(){},onSelect:function(t,e){var a=i.datepicker.parseDate("yy-mm-dd",t);"ticket_start_date"===e.id?(i("#ticket_end_date").datepicker("option","minDate",a),a?i(".ticket_start_time").show():i(".ticket_start_time").hide()):(i("#ticket_start_date").datepicker("option","maxDate",a),a?i(".ticket_end_time").show():i(".ticket_end_time").hide())}};i.extend(w,tribe_l10n_datatables.datepicker),i("#ticket_start_date").datepicker(w).keyup(function(t){8!==t.keyCode&&46!==t.keyCode||i.datepicker._clearDate(this)}),i("#ticket_end_date").datepicker(w).keyup(function(t){8!==t.keyCode&&46!==t.keyCode||i.datepicker._clearDate(this)}),d.change(p),d.trigger("change"),s=!1,i("input[name=ticket_provider]:radio").change(function(){u()}),i("input[name=ticket_provider]:checked").each(function(){u()}),i(document.getElementById("settings_form_toggle")).click(function(t){v("top"),y(),t.preventDefault()}),i(document.getElementById("settings_form_cancel")).click(function(t){v("top"),y(),t.preventDefault()}),i(".ticket_form_toggle").click(function(t){v("left"),b(),n.trigger("clear.tribe").trigger("set-advanced-fields.tribe").trigger("focus.tribe"),i("#ticket_form").show(),i(document.getElementById("tribetickets")).trigger("ticket-provider-changed.tribe"),t.preventDefault()}),i(document.getElementById("ticket_form_cancel")).click(function(){b(),v("left"),n.trigger("clear.tribe").trigger("set-advanced-fields.tribe").trigger("focus.tribe"),e.preventDefault()}),i("#ticket_form_save").click(function(t){var e=i("#ticket_form_table"),a=e.find(".ticket_provider:checked").val(),r=e.find(".ticket, .ticket_advanced_meta, .ticket_advanced_"+a);n.trigger("save-ticket.tribe",t).trigger("spin.tribe","start");var c={action:"tribe-ticket-add-"+i("input[name=ticket_provider]:checked").val(),formdata:r.find(".ticket_field").serialize(),post_ID:i("#post_ID").val(),nonce:TribeTickets.add_ticket_nonce};i.post(ajaxurl,c,function(t){n.trigger("saved-ticket.tribe",t),t.success&&(n.trigger("clear.tribe"),i("td.ticket_list_container").empty().html(t.data.html),i(".ticket_time").hide())},"json").complete(function(){n.trigger("spin.tribe","stop").trigger("focus.tribe")})}),n.on("click",".ticket_delete",function(t){if(!confirm(tribe_ticket_notices.confirm_alert))return!1;t.preventDefault(),n.trigger("delete-ticket.tribe",t).trigger("spin.tribe","start");var e={action:"tribe-ticket-delete-"+i(this).attr("attr-provider"),post_ID:i("#post_ID").val(),ticket_id:i(this).attr("attr-ticket-id"),nonce:TribeTickets.remove_ticket_nonce};i.post(ajaxurl,e,function(t){n.trigger("deleted-ticket.tribe",t),t.success&&(n.trigger("clear.tribe"),i("td.ticket_list_container").empty().html(t.data))},"json").complete(function(){n.trigger("spin.tribe","stop")})}),n.on("click",".ticket_edit",function(t){t.preventDefault(),i("h4.ticket_form_title_edit").show(),i("h4.ticket_form_title_add").hide(),n.trigger("spin.tribe","start");var e={action:"tribe-ticket-edit-"+i(this).attr("attr-provider"),post_ID:i("#post_ID").val(),ticket_id:i(this).attr("attr-ticket-id"),nonce:TribeTickets.edit_ticket_nonce};i.post(ajaxurl,e,function(t){n.trigger("clear.tribe").trigger("set-advanced-fields.tribe").trigger("edit-ticket.tribe",t);var e=t.data.price,a=e,r=!1;"undefined"!=typeof t.data.on_sale&&t.data.on_sale&&(r=!0,e=t.data.regular_price),i("#ticket_id").val(t.data.ID),i("#ticket_name").val(t.data.name),i("#ticket_description").val(t.data.description),r&&i(".ticket_advanced_"+t.data.provider_class+".sale_price").show();var c=t.data.start_date.substring(0,10),d=t.data.end_date.substring(0,10);i("#ticket_start_date").val(c),i("#ticket_end_date").val(d);var o=(i(document.getElementById("ticket_start_meridian")),i(document.getElementById("ticket_end_meridian")));if(t.data.start_date){var s=parseInt(t.data.start_date.substring(11,13)),l="am";s>12&&(l="pm",s=parseInt(s)-12,s=("0"+s).slice(-2)),12===s&&(l="pm"),0===s&&"am"===l&&(s=12),s=s.toString(),1===s.length&&(s="0"+s),i("#ticket_start_hour").val(s).trigger("change"),i("#ticket_start_minute").val(t.data.start_date.substring(14,16)).trigger("change"),i("#ticket_start_meridian").val(l).trigger("change"),i(".ticket_start_time").show()}if(t.data.end_date){var _=parseInt(t.data.end_date.substring(11,13)),g="am";_>12&&o.length&&(g="pm",_=parseInt(_)-12,_=("0"+_).slice(-2)),12===_&&(g="pm"),0===_&&"am"===g&&(_=12),_=_.toString(),1===_.length&&(_="0"+_),i("#ticket_end_hour").val(_).trigger("change"),i("#ticket_end_minute").val(t.data.end_date.substring(14,16)).trigger("change"),i("#ticket_end_meridian").val(g).trigger("change"),i(".ticket_end_time").show()}var k=i("tr.ticket_advanced input");k.data("name",k.attr("name")).attr({name:"",id:""}),i("tr.ticket_advanced").remove(),i("tr.ticket.bottom").before(t.data.advanced_fields),i("input:radio[name=ticket_provider]").filter("[value="+t.data.provider_class+"]").click(),i("input[name=ticket_provider]:radio").change();var m=n.find("#ticket_price");m.val(e),"undefined"!=typeof t.data.disallow_update_price_message?m.siblings(".no-update-message").html(t.data.disallow_update_price_message):m.siblings(".no-update-message").html(""),"undefined"==typeof t.data.can_update_price||t.data.can_update_price?(m.removeProp("disabled"),m.siblings(".description").show(),m.siblings(".no-update-message").hide()):(m.prop("disabled","disabled"),m.siblings(".description").hide(),m.siblings(".no-update-message").show());var p=n.find("#ticket_sale_price");r?p.val(a).closest("tr").show():p.closest("tr").hide(),"undefined"!=typeof t.data.purchase_limit&&t.data.purchase_limit&&i("#ticket_purchase_limit").val(t.data.purchase_limit),n.find(".tribe-bumpdown-trigger").bumpdown(),i("a#ticket_form_toggle").hide(),i("#ticket_form").show(),n.trigger("set-advanced-fields.tribe").trigger("edit-ticket.tribe",t)},"json").complete(function(){n.trigger("spin.tribe","stop").trigger("focus.tribe").trigger("edit-tickets-complete.tribe")})}).on("click","#tribe_ticket_header_image",function(t){t.preventDefault(),ticketHeaderImage.uploader("","")}).on("keyup","#ticket_price",function(t){t.preventDefault();var e,a=price_format.decimal;e=new RegExp("[^-0-9%\\"+a+"]+","gi");var r=i(this).val(),n=r.replace(e,"");r!==n&&i(this).val(n)});var I=i("#tribe_ticket_header_remove"),D=i("#tribe_ticket_header_preview");if(D.find("img").length&&I.show(),o.change(function(){s=!0}),i('input[type="submit"]').click(function(){s=!1}),i(t).on("beforeunload",function(){if(s)return tribe_global_stock_admin_ui.nav_away_msg}),i("body").on("click","#tribe_ticket_header_remove",function(t){t.preventDefault(),D.html(""),I.hide(),i("#tribe_ticket_header_image_id").val("")}),i("#tribe_ticket_header_preview img").length){var B=i("#tribe_ticket_header_preview img");B.removeAttr("width").removeAttr("height"),n.width()<B.width()&&B.css("width","95%")}})}(window,jQuery);