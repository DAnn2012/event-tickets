var ticketHeaderImage=window.ticketHeaderImage||{};!function(e,t,i){"use strict";function a(e){"undefined"==typeof e&&(e=!0);var i=r.find(".tribe-ticket-editor-field-default_provider").filter(":checked"),a="Tribe__Tickets__RSVP_radio";!e&&i.length>0&&(a=i.val()+"_radio"),t(document.getElementById(a)).prop("checked",!0).trigger("change")}var n=(t("html, body"),t(document)),r=t(document.getElementById("tribetickets"));if(0!==r.length){var d=(t(document.getElementById("event_tickets")),t(document.getElementById("post_ID"))),c=t(document.getElementById("publish")),o=r.find(".tribe-tickets-editor-blocker"),l=r.find(".spinner"),s=t(document.getElementById("tribe_panel_base")),p=t(document.getElementById("tribe_panel_edit")),m=t(document.getElementById("tribe_panel_settings")),_=["yy-mm-dd","m/d/yy","mm/dd/yy","d/m/yy","dd/mm/yy","m-d-yy","mm-dd-yy","d-m-yy","dd-mm-yy","yy.mm.dd","mm.dd.yy","dd.mm.yy"],u=_[0],f=function(e,i){if("undefined"==typeof i){var a=t(this);i=a.val()}if(void 0!==i){i||(i=0),i=parseInt(i,10);var n=t(".tribe-ticket-capacity-max"),r=n.find(".tribe-ticket-capacity-value"),d=t('.tribe-ticket-field-capacity[name="tribe-ticket[capacity]"]');d.attr("placeholder",i),i?d.attr("max",i):i=0,r.text(i)}},k=function(e){var t=!1;return"true"===s.attr("aria-hidden")&&(t=tribe_global_stock_admin_ui.nav_away_msg),e.returnValue=t,t};ticketHeaderImage={uploader:function(){var e=wp.media({title:HeaderImageData.title,multiple:!1,library:{type:"image"},button:{text:HeaderImageData.button}});return e.on("close",function(){var t=e.state().get("selection").toJSON();t.length&&ticketHeaderImage.render(t[0])}),e.open(),!1},render:function(e){t(document.getElementById("tribe_ticket_header_preview")).html(ticketHeaderImage.imgHTML(e)),t(document.getElementById("tribe_ticket_header_image_id")).val(e.id),t(document.getElementById("tribe_ticket_header_remove")).show(),t(document.getElementById("tribe_tickets_image_preview_filename")).show().find(".filename").text(e.filename)},imgHTML:function(e){var t='<img src="'+e.url+'" ';return t+='width="'+e.width+'" ',t+='height="'+e.height+'" ',t+="/>"}},i.panels={list:"#tribe_panel_base",ticket:"#tribe_panel_edit",settings:"#tribe_panel_settings"},i.swapPanel=function(a){var n;n=a instanceof jQuery?a:"undefined"!=typeof i.panels[a]?t(i.panels[a]):s,r.find(".ticket_panel").each(function(){t(this).attr("aria-hidden",!0)}),n.attr("aria-hidden",!1),n.is(s)?t(e).off("beforeunload.tribe"):t(e).on("beforeunload.tribe",k)},i.fetchPanels=function(e,a){"undefined"==typeof e&&(e=[]);var n={action:"tribe-ticket-panels",notice:!1,post_id:d.val(),nonce:TribeTickets.add_ticket_nonce,data:e,is_admin:t("body").hasClass("wp-admin")};t.post(ajaxurl,n,function(e){e.success&&i.refreshPanels(e.data,a)})},i.refreshPanels=function(e,a){s=t(e.list),p=t(e.ticket),m=t(e.settings),r.find(i.panels.list).replaceWith(s),r.find(i.panels.ticket).replaceWith(p),r.find(i.panels.settings).replaceWith(m),i.setupPanels(),i.swapPanel(a)},i.setupPanels=function(){e.MTAccordion({target:".accordion"});var i=t(document.getElementById("tribe-event-datepickers")),a=t(document.getElementById("ticket_start_date")),n=t(document.getElementById("ticket_end_date")),d=(t(document.getElementById("ticket_start_time")),t(document.getElementById("ticket_end_time")),0);if(i.length&&(d=i.data("startofweek")),"undefined"!=typeof tribe_dynamic_help_text){var c=t.isNumeric(tribe_dynamic_help_text.datepicker_format_index)?tribe_dynamic_help_text.datepicker_format_index:0;u=_[c]}var o={dateFormat:u,showAnim:"fadeIn",changeMonth:!0,changeYear:!0,numberOfMonths:3,firstDay:d,showButtonPanel:!1,onChange:function(){},beforeShow:function(e,i){i.input.data("prevDate",i.input.datepicker("getDate"));var a=t(i.dpDiv);a.addClass("tribe-ui-datepicker"),a.attrchange({trackValues:!0,callback:function(e){(e.newValue.indexOf("display: none")>=0||e.newValue.indexOf("display:none")>=0)&&a.removeClass("tribe-ui-datepicker")}})},onSelect:function(e,i){var r=t.datepicker.parseDate(u,e);"ticket_start_date"===i.id?n.datepicker("option","minDate",r):a.datepicker("option","maxDate",r)}};t.extend(o,tribe_l10n_datatables.datepicker);var l=r.find(".tribe-timepicker:not(.ui-timepicker-input)");if(tribe_timepickers.setup_timepickers(l),a.datepicker(o).datepicker("option","defaultDate",t(document.getElementById("EventStartDate")).val()).keyup(function(e){8!==e.keyCode&&46!==e.keyCode||t.datepicker._clearDate(this)}),n.datepicker(o).datepicker("option","defaultDate",t(document.getElementById("EventEndDate")).val()).keyup(function(e){8!==e.keyCode&&46!==e.keyCode||t.datepicker._clearDate(this)}),t(document.getElementById("tribe_ticket_header_preview")).find("img").length){t(document.getElementById("tribe_ticket_header_remove")).show();var s=t(document.getElementById("tribe_ticket_header_preview")).find("img");s.removeAttr("width").removeAttr("height"),r.width()<s.width()&&s.css("width","95%")}r.find(tribe.validation.selector.item).validation(),r.find(".tribe-dependent").dependency(),r.find(".tribe-dependency").trigger("verify.dependency")},n.ajaxSend(function(e,i,a){"string"===t.type(a.data)&&-1!==a.data.indexOf("action=tribe-ticket")&&r.trigger("spin.tribe","start")}),n.ajaxComplete(function(e,i,a){"string"===t.type(a.data)&&-1!==a.data.indexOf("action=tribe-ticket")&&r.trigger("spin.tribe","stop")}),n.on({"spin.tribe":function(e,i){("undefined"==typeof i||t.inArray(i,["start","stop"]))&&(i="stop"),"stop"===i?(o.hide(),l.removeClass("is-active")):(o.show(),l.addClass("is-active"))}}),c.on("click.tribe-ticket-editing-in-progress",function(i){return!("true"===s.attr("aria-hidden")&&!confirm(s.data("save-prompt")))&&void t(e).off("beforeunload.tribe")}),n.on("click","#settings_form_toggle",function(e){return e.preventDefault(),i.fetchPanels(null,"settings"),!1}),n.on("click","#tribe_settings_form_cancel, #ticket_form_cancel",function(e){return e.preventDefault(),i.fetchPanels(null,"list"),!1}),n.on("click","#tribe_settings_form_save",function(e){e.preventDefault();var t=m.find("input,textarea").serialize();return i.fetchPanels(t,"list"),!1}),n.on("click",".ticket_form_toggle",function(e){e.preventDefault();var n=t(this);return a("rsvp_form_toggle"===n.attr("id")),p.find(".tribe-dependency").trigger("verify.dependency"),p.find(".tribe-ticket-field-event-capacity").prop("disabled",!0),i.swapPanel("ticket"),!1}),n.on("click",".ticket_edit_button",function(e){e.preventDefault();var a=t(this),n={action:"tribe-ticket-edit",post_id:d.val(),ticket_id:a.data("ticketId"),nonce:TribeTickets.edit_ticket_nonce,is_admin:t("body").hasClass("wp-admin")};return t.post(ajaxurl,n,function(e){e.success&&i.refreshPanels(e.data,"ticket")}),!1}),n.on("click.tribe",'[name="ticket_form_save"]',function(e){var a=t(document.getElementById("ticket_form_table"));if(a.trigger("validation.tribe"),!tribe.validation.hasErrors(a)){r.trigger("pre-save-ticket.tribe",e);var n=s.find(".tribe-ticket-field-order"),c={action:"tribe-ticket-add",data:p.find("input,textarea").serialize(),post_id:d.val(),nonce:TribeTickets.add_ticket_nonce,menu_order:n.length,is_admin:t("body").hasClass("wp-admin")};t.post(ajaxurl,c,function(e){e.success&&i.refreshPanels(e.data)})}}),n.on("click",".ticket_delete",function(e){if(!confirm(tribe_ticket_notices.confirm_alert))return!1;e.preventDefault(),r.trigger("delete-ticket.tribe",e);var a=t(this).attr("attr-ticket-id"),n={action:"tribe-ticket-delete",post_id:d.val(),ticket_id:a,nonce:TribeTickets.remove_ticket_nonce,is_admin:t("body").hasClass("wp-admin")};t.post(ajaxurl,n,function(e){e.success&&i.refreshPanels(e.data)})}),n.on("change",".tribe-ticket-field-capacity",function(e){var i=t(this),a=i.parents(".input_block").eq(0).find(".tribe-ticket-field-mode");i.val()&&a.val("capped")}),n.on("keyup","#ticket_price",function(e){e.preventDefault();var i=price_format.decimal,a=new RegExp("[^-0-9%\\"+i+"]+","gi"),n=t(this).val(),r=n.replace(a,"");n!==r&&t(this).val(r)}),n.on("click","#tribe_ticket_header_image, #tribe_ticket_header_preview",function(e){e.preventDefault(),ticketHeaderImage.uploader("","")}),n.on("focus","#settings_global_capacity_edit",function(){var e=t(this),i=0,a=t(".tribe-tickets-editor-capacity-table").find("[data-capacity]");a.each(function(){var e=t(this);i+=parseInt(e.data("capacity"),10)}),e.data("nonSharedCapacity",i)}),n.on("blur change","#settings_global_capacity_edit",function(){var e=t(".tribe-tickets-editor-table-row-capacity-total"),i=parseInt(e.data("totalCapacity"),10);if(-1!==i){var a=t(this),n=e.find(".tribe-tickets-editor-total-capacity"),r=parseInt(a.val(),10),d=a.data("nonSharedCapacity");(""===r||0>r)&&(a.val(0),r=0);var c=d+r;n.text(c)}}),n.on("click","#global_capacity_edit_button",function(e){e.preventDefault(),t(document.getElementById("settings_global_capacity_edit")).prop("disabled",!1).focus()}),n.on("blur",'[name="tribe-ticket[event_capacity]"]',f),n.on("change",'[name="tribe-ticket[capacity]"]',function(e){var i=t(this),a=parseInt(i.attr("max"),10),n=parseInt(i.val(),10);a&&a<n&&i.val(a)}),n.on("change","#tribe-tickets-global-stock-level",f),n.on("click","#tribe_ticket_header_remove",function(e){e.preventDefault(),t(document.getElementById("tribe_ticket_header_preview")).html(""),t(document.getElementById("tribe_ticket_header_remove")).hide(),t(document.getElementById("tribe_tickets_image_preview_filename")).hide().find(".filename").text(""),t(document.getElementById("tribe_ticket_header_image_id")).val("")}),n.ready(function(){i.setupPanels()})}}(window,jQuery,{});